; C418 - Mellohi
; BPM = 90
; 4分音符 667ms
; 500 166 667 667
	LIST	P=PIC16F84A
	INCLUDE	"P16F84A.INC"

CALL_ MACRO CPRE, CMAIN
	MOVLW	CPRE
	MOVWF	CNTPRE
	MOVLW	CMAIN
	MOVWF	CNTPOST
	CALL	TIME_
	ENDM

	__CONFIG	_HS_OSC&_WDT_OFF

CBLOCK	0CH
TMP ;テーブルで使用される
CNT50U ;TIME50Uで使用される
CNT_ ;TIME_で使用される
CNTPLAY ;PLAYFx50で使用される
CNTPRE	;TIME_でのPREループの数
CNTPOST ;TIME_でのメインループの数
SCALE ;音階(0:D4)
LENGTH ;音の長さ(1:166)
ENDC

CBLOCK 0H
D4
E4
FS4
G4

GS4
A4
AS4
B4

C5
CS5
D5
DS5

E5
F5
FS5
G5

GS5
A5
ENDC

	ORG		0H

MAIN
	BSF		STATUS, RP0
	CLRF	TRISB
	BCF		STATUS, RP0
MAINLP
	CALL	SECTION1

;出力を反転させる
TOGGLE
	MOVLW	b'00000001'
	XORWF	PORTB, F
	RETURN

;50us・250c(250c*0.2us)
TIME50U						
	MOVLW	052H		; 1c 52H = 82		
	MOVWF	CNT50U		; 1c
	NOP					; 1c
	NOP					; 1c
	NOP					; 1c
LOOP50U
	DECFSZ	CNT50U, F		; 1*(82-1)+2*1 = 83
	GOTO	LOOP50U		; 2*(82-2) = 160
	RETURN				; 2c

TIME_
	MOVF	CNTPRE, W
	MOVWF	CNT_
LOOP_PRE
	DECFSZ	CNT_, F
	GOTO	LOOP_PRE

	MOVF	CNTPOST, W
	MOVWF	CNT_
LOOP_POST
	CALL	TIME50U
	DECFSZ	CNT_, F
	GOTO	LOOP_POST
	RETURN

;SCALEからCNTPREの値を返す
PREFROMSCALE
	MOVF	SCALE, W
	MOVWF	TMP
	MOVF	PCL, W
	BCF		STATUS, C
	RLF		TMP, W
	ADDWF	PCL, F
	DT		74H, 92H, 28H, 54H
	DT		86H, 16H, 1H, 47H
	DT		3DH, 39H, 3AH, 3FH
	DT		49H, 2H, 14H, 2AH
	DT		43H, BH

;SCALEからCNTPOSTの値を返す
POSTFROMSCALE
	MOVF	SCALE, W
	MOVWF	TMP
	MOVF	PCL, W
	BCF		STATUS, C
	RLF		TMP, W
	ADDWF	PCL, F
	DT		20H, 1CH, 1A, 18H
	DT		16H, 16H, 15H, 13H
	DT		12H, 11H, 10H, FH
	DT		EH, EH, DH, CH
	DT		BH, BH

TIMEx5
	MOVLW	5H
	MOVWF	CNTPLAY
TIMEx5
	CALL	TIME_
	CALL	TOGGLE
	DECFSZ	CNTPLAY, F
	GOTO	LOOPFx5
	RETURN

SECTION1
	MOVLW	

	END